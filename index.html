<html>


<body>

<div class="debug"></div>

<script>
function dbg(str){
   document.querySelector(".debug").innerHTML = str;
}

let axios = {
  'get': (url, token, noParse) => {
    return new Promise((resolve, reject) => {
      try {
        var xmlhttp = new XMLHttpRequest();
        
        xmlhttp.onreadystatechange = function () {
          if (this.readyState == 4 && String(this.status).startsWith('2')) {
            try {
              if (!noParse) {
                resolve(JSON.parse(this.responseText));
              } else {
                resolve(this.responseText);
              }
            } catch(e) {
              resolve();
            }
          } else if (this.responseText) {
            try {
              if (!noParse) {
                resolve(JSON.parse(this.responseText));
              } else {
                resolve(this.responseText);
              }
            } catch(e) {}
          }
        };
        xmlhttp.onerror = function () {
          if (this.responseText) {
            try {
              if (!noParse) {
                resolve(JSON.parse(this.responseText));
              } else {
                resolve(this.responseText);
              }
            } catch(e) {}
          }
        };

        xmlhttp.open('GET', url, true);
        xmlhttp.send();
      } catch(e) { reject(e) }
    });
  }
};

function toMil(str)
{
  //const theBigDay = new Date(1962, 6, 7, 12); // noon of 1962-07-07 (7th of July 1962, month is 0-indexed)
  let dt = [];
  //'23/11/2022 22:51:00'
  let rss = str.split(' ');
  let dt = rss[0].split('/');
  let y = Number(dt[2]);
  let m = Number(dt[1])
  let d = Number(dt[0]);
  
  let timr = rss[1];
  let tim = timr.split(':');
  let h = Number(timr[0]);
  let m = Number(timr[1]);
  let s = Number(timr[2]);
  
  return new Date(y,d,m,h,m,s).getMilliseconds();
}

async function getNextTrain(){
  
  //const urlRakevet = 'https://www.rail.co.il/apiinfo/api/Plan';
  let proxy = 'https://scepter-cors2.herokuapp.com/';
  
  let date = ''+(new Date().getFullYear()) + (new Date().getMonth()+1 % 12 ) + (new Date().getDate());//20221124
  let hour = ''+(new Date().getHours()) + (new Date().getMinutes());//0600
    
  console.log(date,hour)  
  let str = 'GetRoutes?OId=4600&TId=7300&Date=20221124&Hour=0600&isGoing&=true&IOT=true&c=1669230206330'
  //Tel aviv hashalom to BeerSheva University
  const urlRakevet = `https://www.rail.co.il/apiinfo/api/Plan/GetRoutes?OId=4600&TId=7300&Date=${date}&Hour=${hour}&isGoing=true&IOT=true&&c=1669230206330`;
  
  const resp = await axios.get(proxy + urlRakevet);
  
   
  let DepTime = resp.Data.Routes[0].Train[0].DepartureTime;// '23/11/2022 22:51:00'
  //DirectTrain==true
  
  let relTrains=[];
  
  let currTime = new Date().getMilliseconds();

  
  let r=0;
  for(let r=0;r<resp.Data.Routes.length;r++)
  {
    for(let t=0;t<resp.Data.Routes[r].Train.length;t++)
    {
      if(relTrains.length < 3 ){
        let depTime = resp.Data.Routes[r].Train[t].DepartureTime;
        
        let inTime = (toMil(depTime) - currTime)/1000/60 > 15min; //TBD
        let fast = resp.Data.Routes[0].Train[0].DirectTrain;
        
        if(inTime)
          relTrains.push(depTime);
      }
    }
  }
  
  
  console.log(resp);  
  //dbg(JSON.stringify(resp))
  //console.log(JSON.stringify(resp));
}

getNextTrain();

</script>


</body>


</html>